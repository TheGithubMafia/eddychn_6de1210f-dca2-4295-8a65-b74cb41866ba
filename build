#!/bin/bash

DEBUG=0
OPT="-O2"
WARN="-W1"
CFLAGS="-pipe -Iheaders -o server"
LIBS="-lz -lpthread"

LUA_ENABLED=0

for a in "$@"
do
    if [ "$a" == "lua" ]; then LUA_ENABLED=1; fi
		if [ "$a" == "dbg" ]; then DEBUG=1; fi
    if [ "$a" == "wall" ]; then WARN="-Wall"; fi
    if [ "$a" == "nowarn" ]; then WARN="-W0"; fi
    if [ "$a" == "0" ]; then OPT="-O0"; fi
    if [ "$a" == "1" ]; then OPT="-O1"; fi
    if [ "$a" == "2" ]; then OPT="-O2"; fi
    if [ "$a" == "3" ]; then OPT="-O3"; fi
    if [ "$a" == "f" ]; then OPT="-Ofast"; fi
done

if [ $LUA_ENABLED -eq 1 ];
then
	LUA_INCDIR=`dirname $(find /usr -name lua.h -print -quit 2> /dev/null)`
	LUA_LIBFILE=`basename $(find /usr -name liblua*.a -print -quit 2> /dev/null) .a | tail -c +4`
	CFLAGS="$CFLAGS -I$LUA_INCDIR -DLUA_ENABLED"
	LIBS="$LIBS -l$LUA_LIBFILE"
fi

if [ $DEBUG -eq 1 ];
then
	CFLAGS="$CFLAGS -g"
	OPT="-O0"
fi

gcc code/*.c $WARN $OPT $CFLAGS $LIBS
